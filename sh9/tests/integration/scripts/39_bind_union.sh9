# Test 39: Union directory operations (MBEFORE/MAFTER)
echo "=== union before ==="

# Bootstrap host test directories via /tmp bind
bind /tmp /host_tmp
mkdir /host_tmp/sh9_test_39a
mkdir /host_tmp/sh9_test_39b
echo "from_a" > /host_tmp/sh9_test_39a/a.txt
echo "from_b" > /host_tmp/sh9_test_39b/b.txt
echo "overlay_b" > /host_tmp/sh9_test_39b/a.txt
unmount /host_tmp

# Bind base, then prepend (-b = MBEFORE)
bind /tmp/sh9_test_39a /mnt
bind -b /tmp/sh9_test_39b /mnt

echo "=== ns ==="
ns

# ls should show merged entries
echo "=== ls ==="
ls /mnt

# cat a.txt should show overlay_b (before layer wins)
echo "=== cat a.txt ==="
cat /mnt/a.txt

echo "=== cat b.txt ==="
cat /mnt/b.txt

# Unmount the overlay
unmount /tmp/sh9_test_39b /mnt
unmount /mnt

# Now test MAFTER (append)
echo "=== union after ==="
bind /tmp/sh9_test_39a /mnt
bind -a /tmp/sh9_test_39b /mnt

echo "=== ns ==="
ns

# cat a.txt should show from_a (base layer wins)
echo "=== cat a.txt ==="
cat /mnt/a.txt

unmount /mnt

# Cleanup
bind /tmp /host_tmp
rm /host_tmp/sh9_test_39a/a.txt
rm /host_tmp/sh9_test_39b/b.txt
rm /host_tmp/sh9_test_39b/a.txt
rm /host_tmp/sh9_test_39a
rm /host_tmp/sh9_test_39b
unmount /host_tmp
echo "=== union done ==="
